Запрос = Новый Запрос;
Запрос.УстановитьПараметр("ДатаНач",НачалоДня(ТекущаяДата())-7*86400);
Запрос.УстановитьПараметр("ДатаКон",НачалоДня(ТекущаяДата()));
Запрос.Текст = "ВЫБРАТЬ
|	МАКСИМУМ(МРМ_ЛогОбращений.Код) КАК Код,
|	МРМ_ЛогОбращений.НомерТелефона
|ПОМЕСТИТЬ ПоследниеЗаписиЛога
|ИЗ
|	Справочник.МРМ_ЛогОбращений КАК МРМ_ЛогОбращений
|ГДЕ
|	МРМ_ЛогОбращений.ДатаОбращения >= &ДатаНач
|
|СГРУППИРОВАТЬ ПО
|	МРМ_ЛогОбращений.НомерТелефона
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	МРМ_ЛогОбращений.AppVersion,
|	МРМ_ЛогОбращений.НомерТелефона
|ПОМЕСТИТЬ Версии
|ИЗ
|	ПоследниеЗаписиЛога КАК ПоследниеЗаписиЛога
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.МРМ_ЛогОбращений КАК МРМ_ЛогОбращений
|		ПО ПоследниеЗаписиЛога.Код = МРМ_ЛогОбращений.Код
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	MRMlogTTL.Код КАК id,
|	MRMlogTTL.Дата КАК date,
|	MRMlogTTL.PhoneNumber КАК phone,
|	MRMlogTTL.logTTL КАК ttl,
|	Версии.AppVersion
|ИЗ
|	Справочник.MRMlogTTL КАК MRMlogTTL
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Версии КАК Версии
|		ПО MRMlogTTL.PhoneNumber = Версии.НомерТелефона
|ГДЕ
|	MRMlogTTL.Дата >= &ДатаНач
|	И MRMlogTTL.Дата < &ДатаКон
|	И НЕ Версии.AppVersion = """"
|
|УПОРЯДОЧИТЬ ПО
|	MRMlogTTL.Код";

Выборка	= Запрос.Выполнить().Выбрать();
ИмяТемпФайла = ПолучитьИмяВременногоФайла();
Текст = Новый ЗаписьТекста(ИмяТемпФайла, КодировкаТекста.ANSI);
Текст.ЗаписатьСтроку("id;date;phone;ttl;AppVersion");
Пока Выборка.Следующий() Цикл
	Текст.ЗаписатьСтроку(""+Выборка.id+";"+Выборка.date+";"+Выборка.phone+";"+Выборка.ttl+";"+Выборка.AppVersion);
КонецЦикла;		
Текст.Закрыть();

Текст = Новый ЧтениеТекста(ИмяТемпФайла, КодировкаТекста.ANSI);
ТелоЗапроса = Текст.Прочитать();				

Сервер			= "10.2.4.164";
Порт 			= 8083;
ПутьНаСервере	= "/log_ttl_report";

Соединение = Новый HTTPСоединение(Сервер, Порт);
ЗапросСервера = Новый HTTPЗапрос(ПутьНаСервере);
ЗапросСервера.УстановитьТелоИзСтроки(ТелоЗапроса);
//ОтветСервера = Соединение.ВызватьHTTPМетод("POST", ЗапросСервера); //8.3
ОтветСервера = Соединение.ОтправитьДляОбработки(ЗапросСервера); //8.2
//ТелоОтвета = ОтветСервера.ПолучитьТелоКакСтроку();
//КодОтвета = ОтветСервера.КодСостояния;
